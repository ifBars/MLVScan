<Project Sdk="Microsoft.NET.Sdk">
  <!-- ============================================ -->
  <!-- Shared Properties (both configurations)     -->
  <!-- ============================================ -->
  <PropertyGroup>
    <TargetFramework>netstandard2.1</TargetFramework>
    <LangVersion>latest</LangVersion>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>disable</Nullable>
    <RootNamespace>MLVScan</RootNamespace>
    <IsPackable>false</IsPackable>
    <AssemblyVersion>1.6.1</AssemblyVersion>
    <FileVersion>1.6.1</FileVersion>
    <NeutralLanguage>en-US</NeutralLanguage>
    <AllowUnsafeBlocks>True</AllowUnsafeBlocks>
    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
    <Configurations>MelonLoader;BepInEx</Configurations>
  </PropertyGroup>

  <!-- ============================================ -->
  <!-- MelonLoader Configuration                   -->
  <!-- ============================================ -->
  <PropertyGroup Condition="'$(Configuration)'=='MelonLoader'">
    <DefineConstants>MELONLOADER</DefineConstants>
    <AssemblyName>MLVScan.MelonLoader</AssemblyName>
  </PropertyGroup>

  <!-- ============================================ -->
  <!-- BepInEx Configuration                       -->
  <!-- ============================================ -->
  <PropertyGroup Condition="'$(Configuration)'=='BepInEx'">
    <DefineConstants>BEPINEX</DefineConstants>
    <AssemblyName>MLVScan.BepInEx</AssemblyName>
  </PropertyGroup>

  <!-- ============================================ -->
  <!-- Excluded files from default compilation     -->
  <!-- ============================================ -->
  <ItemGroup>
    <None Remove="CLAUDE.md" />
    <None Remove="LOCAL_DEV_GUIDE.md" />
    <None Remove="AGENTS.md" />
    <None Remove="nexuspost.bbcode" />
  </ItemGroup>

  <!-- ============================================ -->
  <!-- Shared Source Files (both configurations)   -->
  <!-- ============================================ -->
  <ItemGroup>
    <Compile Include="PlatformConstants.cs" />
    <Compile Include="Abstractions\IConfigManager.cs" />
    <Compile Include="Abstractions\IPlatformEnvironment.cs" />
    <Compile Include="Services\PluginScannerBase.cs" />
    <Compile Include="Services\PluginDisablerBase.cs" />
    <Compile Include="Services\DeveloperReportGenerator.cs" />
    <Compile Include="Services\IlDumpService.cs" />
    <Compile Include="Services\PromptGeneratorService.cs" />
    <Compile Include="Services\HashUtility.cs" />
  </ItemGroup>

  <!-- ============================================ -->
  <!-- MelonLoader-Specific Source Files           -->
  <!-- ============================================ -->
  <ItemGroup Condition="'$(Configuration)'=='MelonLoader'">
    <Compile Include="Core.cs" />
    <Compile Include="MelonLoader\Adapters\MelonScanLogger.cs" />
    <Compile Include="MelonLoader\Adapters\GameAssemblyResolverProvider.cs" />
    <Compile Include="MelonLoader\MelonConfigManager.cs" />
    <Compile Include="MelonLoader\MelonEnvironment.cs" />
    <Compile Include="MelonLoader\MelonPluginScanner.cs" />
    <Compile Include="MelonLoader\MelonPluginDisabler.cs" />
    <Compile Include="Services\ServiceFactory.cs" />
  </ItemGroup>

  <!-- ============================================ -->
  <!-- BepInEx-Specific Source Files               -->
  <!-- ============================================ -->
  <ItemGroup Condition="'$(Configuration)'=='BepInEx'">
    <Compile Include="BepInEx\MLVScanPatcher.cs" />
    <Compile Include="BepInEx\Adapters\BepInExScanLogger.cs" />
    <Compile Include="BepInEx\Adapters\BepInExAssemblyResolverProvider.cs" />
    <Compile Include="BepInEx\BepInExConfigManager.cs" />
    <Compile Include="BepInEx\BepInExEnvironment.cs" />
    <Compile Include="BepInEx\BepInExPluginScanner.cs" />
    <Compile Include="BepInEx\BepInExPluginDisabler.cs" />
    <Compile Include="BepInEx\BepInExReportGenerator.cs" />
  </ItemGroup>

  <!-- ============================================ -->
  <!-- MelonLoader References                      -->
  <!-- ============================================ -->
  <ItemGroup Condition="'$(Configuration)'=='MelonLoader'">
    <Reference Include="MelonLoader">
      <HintPath>$(MelonLoaderPath)\MelonLoader.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="0Harmony">
      <HintPath>$(MelonLoaderPath)\0Harmony.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <!-- Unity References (only needed for MelonLoader which uses MelonEnvironment) -->
    <Reference Include="UnityEngine.CoreModule">
      <HintPath>$(GameManagedPath)\UnityEngine.CoreModule.dll</HintPath>
      <Private>false</Private>
    </Reference>
  </ItemGroup>

  <!-- ============================================ -->
  <!-- BepInEx References                          -->
  <!-- ============================================ -->
  <ItemGroup Condition="'$(Configuration)'=='BepInEx'">
    <!-- Use NuGet package for BepInEx.Core (compilation only) -->
    <PackageReference Include="BepInEx.Core" Version="5.*" PrivateAssets="all" 
                      Condition="'$(BepInExCorePath)' == ''" />
    <!-- Or use local reference if BepInExCorePath is set -->
    <Reference Include="BepInEx" Private="false" Condition="'$(BepInExCorePath)' != ''">
      <HintPath>$(BepInExCorePath)\BepInEx.dll</HintPath>
    </Reference>
    <Reference Include="0Harmony" Private="false" Condition="'$(BepInExCorePath)' != ''">
      <HintPath>$(BepInExCorePath)\0Harmony.dll</HintPath>
    </Reference>
  </ItemGroup>

  <!-- ============================================ -->
  <!-- Shared Package References                   -->
  <!-- ============================================ -->
  <ItemGroup>
    <!-- Use local project reference when UseLocalMLVScanCore is set -->
    <ProjectReference Include="..\MLVScan.Core\MLVScan.Core.csproj" Condition="'$(UseLocalMLVScanCore)' == 'true'" />
    
    <!-- Use NuGet package by default -->
    <PackageReference Include="MLVScan.Core" Version="*" GeneratePathProperty="true" Condition="'$(UseLocalMLVScanCore)' != 'true'" />
    
    <PackageReference Include="ILRepack" Version="2.0.44" GeneratePathProperty="true" />
    <PackageReference Include="Mono.Cecil" Version="0.11.6" />
    <PackageReference Include="System.Text.Json" Version="8.0.5" />
  </ItemGroup>

  <!-- ============================================ -->
  <!-- ILRepack Target (merge MLVScan.Core)        -->
  <!-- ============================================ -->
  <Target Name="ILRepack" AfterTargets="Build">
    <ItemGroup>
      <InputAssemblies Include="$(TargetPath)" />
      <!-- Use local build output when UseLocalMLVScanCore is true -->
      <InputAssemblies Include="..\MLVScan.Core\bin\$(Configuration)\netstandard2.1\MLVScan.Core.dll" Condition="'$(UseLocalMLVScanCore)' == 'true'" />
      <!-- Use NuGet package when UseLocalMLVScanCore is false or not set -->
      <InputAssemblies Include="$(PkgMLVScan_Core)\lib\netstandard2.1\MLVScan.Core.dll" Condition="'$(UseLocalMLVScanCore)' != 'true'" />
    </ItemGroup>
    <!-- MelonLoader ILRepack -->
    <Exec Condition="'$(Configuration)'=='MelonLoader' and '$(GameManagedPath)' != '' and '$(MelonLoaderPath)' != ''"
          Command="&quot;$(PkgILRepack)\tools\ILRepack.exe&quot; /parallel /union /lib:&quot;$(GameManagedPath)&quot; /lib:&quot;$(MelonLoaderPath)&quot; /out:&quot;$(OutputPath)$(AssemblyName).merged.dll&quot; &quot;@(InputAssemblies, '&quot; &quot;')&quot;" />
    <!-- BepInEx ILRepack -->
    <Exec Condition="'$(Configuration)'=='BepInEx' and '$(BepInExCorePath)' != ''"
          Command="&quot;$(PkgILRepack)\tools\ILRepack.exe&quot; /parallel /union /lib:&quot;$(BepInExCorePath)&quot; /out:&quot;$(OutputPath)$(AssemblyName).merged.dll&quot; &quot;@(InputAssemblies, '&quot; &quot;')&quot;" />
    <Copy SourceFiles="$(OutputPath)$(AssemblyName).merged.dll" DestinationFiles="$(TargetPath)" Condition="Exists('$(OutputPath)$(AssemblyName).merged.dll')" />
  </Target>

  <!-- ============================================ -->
  <!-- Post-Build Copy (MelonLoader)               -->
  <!-- ============================================ -->
  <Target Name="PostBuildMelonLoader" AfterTargets="ILRepack" Condition="'$(Configuration)'=='MelonLoader' and '$(MelonPluginsPath)' != ''">
    <Copy SourceFiles="$(TargetPath)" DestinationFolder="$(MelonPluginsPath)" />
    <Message Text="Copied MLVScan.MelonLoader.dll to $(MelonPluginsPath)" Importance="high" />
  </Target>

  <!-- ============================================ -->
  <!-- Post-Build Copy (BepInEx)                   -->
  <!-- ============================================ -->
  <Target Name="PostBuildBepInEx" AfterTargets="ILRepack" Condition="'$(Configuration)'=='BepInEx' and '$(BepInExPatchersPath)' != ''">
    <MakeDir Directories="$(BepInExPatchersPath)" Condition="!Exists('$(BepInExPatchersPath)')" />
    <Copy SourceFiles="$(TargetPath)" DestinationFolder="$(BepInExPatchersPath)" />
    <Message Text="Copied MLVScan.BepInEx.dll to $(BepInExPatchersPath)" Importance="high" />
  </Target>

  <!-- Import local.build.props if it exists for local dev overrides -->
  <Import Project="local.build.props" Condition="Exists('local.build.props')" />
</Project>
